<!-- Painel de Notifica√ß√µes B2G (Sprint 3) -->
<div id="b2g-notificacoes-panel"
    class="hidden fixed right-4 top-20 w-96 bg-white shadow-2xl rounded-lg border border-gray-200 z-50 max-h-[600px] overflow-hidden flex flex-col">
    <div
        class="p-4 border-b border-gray-200 flex justify-between items-center bg-gradient-to-r from-blue-50 to-purple-50">
        <h3 class="font-bold text-lg text-gray-800">üîî Notifica√ß√µes</h3>
        <div class="flex gap-2">
            <button id="marcar-todas-lidas-btn" class="text-sm text-blue-600 hover:text-blue-800">
                Marcar todas como lidas
            </button>
            <button id="fechar-notif-btn" class="text-gray-500 hover:text-gray-700">
                ‚úï
            </button>
        </div>
    </div>

    <div id="notificacoes-lista" class="flex-1 overflow-y-auto p-4 space-y-3">
        <!-- Notifica√ß√µes carregadas dinamicamente -->
    </div>

    <div class="p-3 border-t border-gray-200 bg-gray-50 text-center">
        <button id="ver-todas-notif-btn" class="text-sm text-blue-600 hover:underline">
            Ver todas as notifica√ß√µes
        </button>
    </div>
</div>

<!-- Modal de Alertas (Sprint 3) -->
<div id="alertas-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
        <div class="p-6 border-b border-gray-200 bg-gradient-to-r from-purple-50 to-pink-50">
            <h2 class="text-2xl font-bold text-gray-800">‚ö° Meus Alertas Personalizados</h2>
            <p class="text-sm text-gray-600 mt-1">Receba notifica√ß√µes quando surgirem oportunidades que atendam seus
                crit√©rios</p>
        </div>

        <div class="flex-1 overflow-y-auto p-6">
            <button id="criar-alerta-btn"
                class="w-full mb-6 px-4 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg font-semibold hover:from-blue-700 hover:to-purple-700 transition shadow-md">
                ‚ûï Criar Novo Alerta
            </button>

            <div id="alertas-lista" class="space-y-4">
                <!-- Alertas carregados dinamicamente -->
            </div>
        </div>

        <div class="p-4 border-t border-gray-200 flex justify-end">
            <button id="fechar-alertas-btn"
                class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                Fechar
            </button>
        </div>
    </div>
</div>

<!-- Modal de Parceiros (Sprint 5) -->
<div id="parceiros-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
        <div class="p-6 border-b border-gray-200 bg-gradient-to-r from-green-50 to-blue-50">
            <h2 class="text-2xl font-bold text-gray-800">ü§ù Parceiros Complementares</h2>
            <p class="text-sm text-gray-600 mt-1">Empresas compat√≠veis para formar cons√≥rcio nesta licita√ß√£o</p>
        </div>

        <div class="flex-1 overflow-y-auto p-6">
            <div id="parceiros-lista" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Parceiros carregados dinamicamente -->
            </div>
        </div>

        <div class="p-4 border-t border-gray-200 flex justify-between">
            <button id="analisar-consorcio-btn"
                class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-semibold">
                üìä Analisar Viabilidade do Cons√≥rcio
            </button>
            <button id="fechar-parceiros-btn"
                class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                Fechar
            </button>
        </div>
    </div>
</div>

    // ==================== NOTIFICA√á√ïES (Sprint 3) ====================
    let notificacoesPanel = null;
    let alertasModal = null;
    let parceirosModal = null;

    document.addEventListener('DOMContentLoaded', () => {
        notificacoesPanel = document.getElementById('b2g-notificacoes-panel');
        alertasModal = document.getElementById('alertas-modal');
        parceirosModal = document.getElementById('parceiros-modal');

        // Event listeners
        document.getElementById('fechar-notif-btn')?.addEventListener('click', fecharNotificacoes);
        document.getElementById('marcar-todas-lidas-btn')?.addEventListener('click', marcarTodasLidas);
        document.getElementById('fechar-alertas-btn')?.addEventListener('click', () => alertasModal.classList.add('hidden'));
        document.getElementById('fechar-parceiros-btn')?.addEventListener('click', () => parceirosModal.classList.add('hidden'));
        document.getElementById('criar-alerta-btn')?.addEventListener('click', mostrarFormularioAlerta);

        // Badge de notifica√ß√µes clic√°vel
        document.addEventListener('click', (e) => {
            if (e.target.id === 'b2g-notif-badge') {
                abrirPainelNotificacoes();
            }
        });
    });

    async function abrirPainelNotificacoes() {
        notificacoesPanel.classList.remove('hidden');
        await carregarListaNotificacoes();
    }

    function fecharNotificacoes() {
        notificacoesPanel.classList.add('hidden');
    }

    async function carregarListaNotificacoes() {
        try {
            const response = await fetch('/api/notificacoes/?limite=20');
            const data = await response.json();

            const lista = document.getElementById('notificacoes-lista');

            if (!data.sucesso || data.notificacoes.length === 0) {
                lista.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhuma notifica√ß√£o</p>';
                return;
            }

            lista.innerHTML = data.notificacoes.map(n => `
            <div class="p-4 rounded-lg border ${n.lida ? 'bg-gray-50 border-gray-200' : 'bg-blue-50 border-blue-200'} hover:shadow-md transition">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-xs font-semibold ${n.lida ? 'text-gray-500' : 'text-blue-600'} uppercase">${n.tipo}</span>
                    <span class="text-xs text-gray-500">${formatarDataNotif(n.criado_em)}</span>
                </div>
                <h4 class="font-semibold text-gray-800 mb-1">${n.titulo}</h4>
                <p class="text-sm text-gray-600">${n.mensagem}</p>
                ${!n.lida ? `<button onclick="marcarComoLida(${n.id})" class="mt-2 text-xs text-blue-600 hover:underline">Marcar como lida</button>` : ''}
            </div>
        `).join('');

        } catch (error) {
            console.error('Erro ao carregar notifica√ß√µes:', error);
        }
    }

    async function marcarComoLida(notifId) {
        try {
            await fetch(`/api/notificacoes/${notifId}/marcar-lida`, { method: 'PUT' });
            await carregarListaNotificacoes();
            await carregarNotificacoesB2G();
        } catch (error) {
            console.error('Erro ao marcar como lida:', error);
        }
    }

    async function marcarTodasLidas() {
        try {
            await fetch('/api/notificacoes/marcar-todas-lidas', { method: 'PUT' });
            await carregarListaNotificacoes();
            await carregarNotificacoesB2G();
        } catch (error) {
            console.error('Erro:', error);
        }
    }

    function formatarDataNotif(data) {
        const d = new Date(data);
        const agora = new Date();
        const diff = agora - d;
        const minutos = Math.floor(diff / 60000);

        if (minutos < 1) return 'Agora';
        if (minutos < 60) return `${minutos}m atr√°s`;
        if (minutos < 1440) return `${Math.floor(minutos / 60)}h atr√°s`;
        return `${Math.floor(minutos / 1440)}d atr√°s`;
    }

    // ==================== PARCEIROS (Sprint 5) ====================
    async function buscarParceiros(licitacao) {
        try {
            const cnpj = '00000000000000'; // TODO: Obter CNPJ da empresa logada

            const response = await fetch('/api/parcerias/buscar-parceiros', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cnpj, licitacao })
            });

            const data = await response.json();

            if (data.sucesso && data.parceiros.length > 0) {
                mostrarParceiros(data.parceiros, licitacao);
            } else {
                alert('Nenhum parceiro encontrado para esta licita√ß√£o');
            }

        } catch (error) {
            console.error('Erro ao buscar parceiros:', error);
        }
    }

    function mostrarParceiros(parceiros, licitacao) {
        const lista = document.getElementById('parceiros-lista');

        lista.innerHTML = parceiros.map(p => `
        <div class="p-4 border border-gray-200 rounded-lg hover:shadow-lg transition">
            <div class="flex items-start justify-between mb-3">
                <div>
                    <h4 class="font-bold text-gray-800">${p.razao_social}</h4>
                    <p class="text-sm text-gray-600">${p.cnpj} ‚Ä¢ ${p.uf}</p>
                </div>
                <div class="text-right">
                    <div class="text-2xl font-bold text-green-600">${p.score_complementaridade}%</div>
                    <p class="text-xs text-gray-500">Score</p>
                </div>
            </div>
            <p class="text-sm text-gray-700 mb-2">
                <strong>Motivo:</strong> ${p.motivo}
            </p>
            <div class="flex gap-2 text-xs text-gray-600">
                <span class="bg-blue-100 px-2 py-1 rounded">Porte: ${p.porte}</span>
                <span class="bg-green-100 px-2 py-1 rounded">${p.historico_consorcios} cons√≥rcios</span>
            </div>
        </div>
    `).join('');

        parceirosModal.classList.remove('hidden');

        // Guardar dados para an√°lise
        window.parceirosAtuais = parceiros;
        window.licitacaoAtual = licitacao;
    }

    function mostrarFormularioAlerta() {
        // TODO: Implementar formul√°rio de criar alerta
        alert('Formul√°rio de criar alerta - A implementar');
    }

    // Adicionar bot√£o de buscar parceiros nos cards de licita√ß√£o
    function adicionarBotaoParceiros(cardElement, licitacao) {
        const btn = document.createElement('button');
        btn.className = 'mt-2 px-3 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200 text-sm font-semibold';
        btn.textContent = 'ü§ù Buscar Parceiros';
        btn.onclick = () => buscarParceiros(licitacao);
        cardElement.appendChild(btn);
    }
</script>


